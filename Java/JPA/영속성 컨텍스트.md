## 영속성 컨텍스트

- 엔티티를 영구 저장하는 환경을 의미함
- 어플리케이션과 DB 사이에서 객체를 보관하는 가상의 DB 역할을 함
- 엔티티 매니저를 통해 엔티티를 저장하거나 조회하면 영속성 컨텍스트에 엔티티르 ㄹ보관하고 관리ㅣ

### 생명주기

<img src="../../img/java-jpa-01.png">
- 비영속(new) : 영속성 컨텍스트와 관계가 없는 상태
- 영속(Managed) : 영속성 컨텍스트에 저장된 상태
- 준영속(detached) : 영속성 컨텍스트에 저장되었다가 분리된 상태
- 삭제(removed) : 삭제된 상태

### 1차 캐시(First-Level_Cache)

- 엔티티를 캐싱하여 동일 트랜잭션 내에선 동일한 엔티티를 재사용
- DB에 대한 불필요한 조회를 방지하고 성능을 향상함
- 동일한 식별자를 가진 엔티티의 동일성을 보장
- 더티체킹으로 엔티티의 변경사항을 자동으로 감지하여 트랜잭션 커밋 시 변경된 내용만 DB에 반영
- 쿼리를 즉시 실행하지 않고 트랜잭션이 커밋될 때 한번에 실행하여 성능을 최적화함
- 지연 로딩을 사용하여 연관 엔티티나 컬렉션을 실제 필요한 시점에 로딩하여 초기 로딩시의 부하를 줄임

#### 1차 캐시 조회의 흐름

1. 1차 캐시에서 엔티티를 찾음
2. 존재하면 메모리에 있는 1차 캐시에서 엔티티를 조회
3. 없는 경우 DB에서 조회
4. 조회한 데이터로 엔티티를 생성하여 1차 캐시에 저장(엔티티를 영속 상태로 만듬)
5. 조회한 엔티티를 반환

#### 1차 캐시와 2차 캐시의 차이

|   항목   |     1차 캐시      |       2차캐시        |
|:------:|:--------------:|:-----------------:|
|   범위   | 엔티티 매니저 또는 세션  |      애플리케이션       |
| 활성화 여부 |       기본       |      활성화 필요       |
|   대상   | 영속성 컨텍스트 내 엔티티 | 엔티티, 컬렉션, 쿼리 결과 등 |
| 구현 방식  |    내부 메커니즘     |   외부 캐시 제공자 사용    |

